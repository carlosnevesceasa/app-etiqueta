<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerador de Etiquetas - Rastreabilidade</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078d7">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      font-size: 14px;
    }
    h1 { text-align: center; color: #007566; margin-bottom: 20px; }
    .logo { width: clamp(80px, 20vw, 200px); margin: auto; padding-bottom: 20px; display: flex; justify-content: center; }
    form { max-width: 600px; margin: 0 auto 20px; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 0 6px #ccc; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type=text], input[type=number], select { width: 100%; padding: 7px 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #aaa; font-size: 14px; }
    button { background: #28a745; border: none; padding: 12px 20px; color: white; font-weight: bold; border-radius: 5px; cursor: pointer; width: 100%; font-size: 14px; margin-top: 10px; }
    .etiquetas { max-width: 900px; margin: 0 auto; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .etiqueta { width: 250px; background: white; border: 1px solid #999; border-radius: 8px; padding: 8px; box-shadow: 1px 1px 6px #ccc; font-size: 14px; page-break-inside: avoid; }
    .etiqueta p { margin: 2px 0; font-size: 14px; }
    .etiqueta table { width: 100%; font-size: 16px; border-collapse: collapse; text-transform: uppercase; }
    .etiqueta td { padding: 1px 4px; vertical-align: middle; }
    .etiqueta-content { display: flex; justify-content: space-between; align-items: flex-start; }
    .produtos { width: 65%; }
    .qrcode { width: 30%; text-align: center; }
    .qrcode div { margin: 0 auto; width: 60px; height: 60px; }
    .qrcode p { margin: 2px 0 0 0; font-size: 12px; text-align: center; }
    #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); z-index:999; display:none; }
    #mensagemProcessamento { position: fixed; top:40%; left:50%; transform: translate(-50%, -50%); background:#fff; border:2px solid #28a745; border-radius:8px; padding:20px 30px; font-size:16px; font-weight:bold; box-shadow:0 0 10px rgba(0,0,0,0.2); display:none; z-index:1000; align-items:center; gap:15px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #28a745; border-radius:50%; width:24px; height:24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @media print {
      form, button, #overlay, #mensagemProcessamento { display: none; }
      .etiquetas { max-width: 100%; justify-content: flex-start; }
      .etiqueta { box-shadow: none; border:1px solid black; width:240px; margin:5px; }
    }
  </style>
</head>
<body>

<div class="logo">
  <img src="https://ceasa.es.gov.br/Media/ceasa/_Profiles/a69f6923/d1b68d0c/testes2-1.png" alt="logo" />
</div>

<h1>Gerador de Etiquetas de Rastreabilidade</h1>

<form id="form">
  <label for="cep">CEP:</label>
  <input type="text" id="cep" maxlength="9" required />

  <label for="produtor">Nome do Produtor:</label>
  <input type="text" id="produtor" required />

  <label for="inscricao">Inscrição Estadual:</label>
  <input type="text" id="inscricao" required />

  <label for="endereco">Endereço da Propriedade:</label>
  <input type="text" id="endereco" required />

  <label>Produtos:</label>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <input type="text" id="produto1" placeholder="Produto 1" required />
    <div style="display: flex; gap: 5px;">
      <input type="text" id="quantidade1" placeholder="Qtd" required style="flex:1;" />
      <select id="unidade1" style="flex:1;">
        <option value="kg">KG</option>
        <option value="un">UN</option>
      </select>
    </div>
    <input type="text" id="produto2" placeholder="Produto 2" />
    <div style="display: flex; gap: 5px;">
      <input type="text" id="quantidade2" placeholder="Qtd" style="flex:1;" />
      <select id="unidade2" style="flex:1;">
        <option value="kg">KG</option>
        <option value="un">UN</option>
      </select>
    </div>
    <input type="text" id="produto3" placeholder="Produto 3" />
    <div style="display: flex; gap: 5px;">
      <input type="text" id="quantidade3" placeholder="Qtd" style="flex:1;" />
      <select id="unidade3" style="flex:1;">
        <option value="kg">KG</option>
        <option value="un">UN</option>
      </select>
    </div>
    <input type="text" id="produto4" placeholder="Produto 4" />
    <div style="display: flex; gap: 5px;">
      <input type="text" id="quantidade4" placeholder="Qtd" style="flex:1;" />
      <select id="unidade4" style="flex:1;">
        <option value="kg">KG</option>
        <option value="un">UN</option>
      </select>
    </div>
  </div>

  <label for="volumes">Quantidade de Volumes (máximo 8):</label>
  <input type="number" id="volumes" min="1" max="8" value="1" required />

  <button type="submit">Gerar Etiquetas</button>
</form>

<div class="etiquetas" id="etiquetas"></div>
<button id="btnPdf" style="display:none;">Exportar para PDF</button>

<div id="overlay"></div>
<div id="mensagemProcessamento">
  <div class="spinner"></div>
  Gerando etiquetas, aguarde...
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const form = document.getElementById('form');
const etiquetasDiv = document.getElementById('etiquetas');
const btnPdf = document.getElementById('btnPdf');
const mensagemProcessamento = document.getElementById('mensagemProcessamento');
const overlay = document.getElementById('overlay');

function limparEtiquetas() { etiquetasDiv.innerHTML = ''; }

function criarEtiqueta(dados, numeroVolume, totalVolumes, lat, lng) {
  const etiqueta = document.createElement('div');
  etiqueta.className = 'etiqueta';
  const temCoordenadas = lat && lng;
  const qrcodeDivId = `qrcode${numeroVolume}`;
  const qrCodeHTML = temCoordenadas ? `<div id="${qrcodeDivId}"></div><p>Localização</p>` : '';

  etiqueta.innerHTML = `
    <p><strong>Produtor:</strong> ${dados.produtor}</p>
    <p><strong>IE:</strong> ${dados.inscricao}</p>
    <p><strong>Endereço:</strong> ${dados.endereco}</p>
    <div class="etiqueta-content">
      <div class="produtos">
        <table>
          ${[1,2,3,4].map(i=>{
            const nome=dados[`produto${i}`]; const qtd=dados[`quantidade${i}`]; const un=dados[`unidade${i}`];
            if(!nome||!qtd) return '';
            return `<tr><td><input type="checkbox" /></td><td>${nome}</td><td style="text-align:right;">${qtd}${un}</td></tr>`;
          }).join('')}
        </table>
      </div>
      <div class="qrcode">${qrCodeHTML}</div>
    </div>
    <p style="font-style:italic; font-size:14px; margin-top:4px;">Lote/Data: ____________________</p>
  `;
  etiquetasDiv.appendChild(etiqueta);

  if(temCoordenadas){
    new QRCode(document.getElementById(qrcodeDivId), { text: `https://maps.google.com/?q=${lat},${lng}`, width:60, height:60 });
  }
}

async function buscarCoordenadas(cep){
  const cepLimpo = cep.replace(/\D/g,'');
  if(cepLimpo.length!==8) return null;
  try {
    const responseCep = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
    if(!responseCep.ok) throw new Error();
    const dadosCep = await responseCep.json();
    if(dadosCep.erro) throw new Error();
    const enderecoCompleto = `${dadosCep.logradouro}, ${dadosCep.localidade}, ${dadosCep.uf}, Brasil`;
    const responseNom = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(enderecoCompleto)}&format=json&limit=1&countrycodes=BR`);
    const dadosNom = await responseNom.json();
    if(dadosNom.length===0) throw new Error();
    return { lat: dadosNom[0].lat, lng: dadosNom[0].lon };
  } catch { return null; }
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  limparEtiquetas();
  btnPdf.style.display='none';
  overlay.style.display='block';
  mensagemProcessamento.style.display='flex';

  const dados={
    cep: form.cep.value,
    produtor: form.produtor.value,
    inscricao: form.inscricao.value,
    endereco: form.endereco.value,
    volumes: parseInt(form.volumes.value,10)
  };

  for(let i=1;i<=4;i++){
    dados[`produto${i}`]=form[`produto${i}`].value;
    dados[`quantidade${i}`]=form[`quantidade${i}`].value;
    dados[`unidade${i}`]=form[`unidade${i}`].value;
  }

  const coords = await buscarCoordenadas(dados.cep);

  for(let i=1;i<=dados.volumes;i++){
    criarEtiqueta(dados,i,dados.volumes,coords?.lat,coords?.lng);
  }

  overlay.style.display='none';
  mensagemProcessamento.style.display='none';
  btnPdf.style.display='block';
});

btnPdf.addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  btnPdf.disabled=true;
  const canvas = await html2canvas(etiquetasDiv,{scale:2,width:794,windowWidth:794});
  const pdf = new jsPDF('p','pt','a4');
  const imgData = canvas.toDataURL('image/png');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const imgHeight = (canvas.height*pdfWidth)/canvas.width;
  pdf.addImage(imgData,'PNG',0,0,pdfWidth,imgHeight);
  pdf.save('etiquetas.pdf');
  btnPdf.disabled=false;
});

// Service Worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("/sw.js")
    .then(()=>console.log("Service Worker registrado!"))
    .catch(err=>console.error("Erro no SW:", err));
}

// Botão de instalação PWA
let deferredPrompt;
window.addEventListener("beforeinstallprompt", e=>{
  e.preventDefault();
  deferredPrompt=e;
  const btn=document.createElement("button");
  btn.textContent="Instalar App";
  btn.style.position="fixed";
  btn.style.bottom="10px";
  btn.style.right="10px";
  btn.style.zIndex="10000";
  btn.style.padding="10px 15px";
  btn.style.background="#0078d7";
  btn.style.color="white";
  btn.style.border="none";
  btn.style.borderRadius="5px";
  document.body.appendChild(btn);
  btn.addEventListener("click", ()=>{
    btn.style.display="none";
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(()=>deferredPrompt=null);
  });
});
</script>
</body>
</html>
